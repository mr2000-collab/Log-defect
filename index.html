<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Defect System - Login & Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { background-color: #e9ecef; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        
        /* AUTH STYLES */
        .auth-container { max-width: 450px; margin: 80px auto; }
        .auth-card { padding: 30px; border-radius: 10px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); background: white; }
        .hidden { display: none; }
        
        /* APP STYLES */
        .page-section { display: none; padding: 20px; }
        .active-page { display: block; animation: fadeIn 0.4s; }
        .nav-btn { height: 120px; display: flex; align-items: center; justify-content: center; font-size: 1.3rem; font-weight: 500; cursor: pointer; transition: 0.2s; }
        .nav-btn:hover { transform: scale(1.02); shadow: 0 5px 15px rgba(0,0,0,0.2); }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

    <div id="view-login" class="container auth-container">
        <div class="auth-card">
            <h3 class="text-center mb-4">System Login</h3>
            <form onsubmit="handleLogin(event)">
                <div class="mb-3">
                    <label>Email Address</label>
                    <input type="email" id="loginEmail" class="form-control" required>
                </div>
                <div class="mb-3">
                    <label>Password</label>
                    <input type="password" id="loginPass" class="form-control" required>
                </div>
                <div class="d-grid mb-3">
                    <button type="submit" class="btn btn-primary btn-lg">Login</button>
                </div>
                <div class="d-flex justify-content-between">
                    <a href="#" onclick="switchAuth('register')">Register New Account</a>
                    <a href="#" onclick="switchAuth('reset')">Forgot Password?</a>
                </div>
            </form>
        </div>
    </div>

    <div id="view-register" class="container auth-container hidden">
        <div class="auth-card">
            <h3 class="text-center mb-4">Register</h3>
            <div id="reg-step-1">
                <div class="mb-3"><label>Full Name</label><input type="text" id="regName" class="form-control"></div>
                <div class="mb-3"><label>Email</label><input type="email" id="regEmail" class="form-control"></div>
                <div class="mb-3"><label>Password</label><input type="password" id="regPass" class="form-control"></div>
                <div class="d-grid">
                    <button onclick="sendRegisterOTP()" class="btn btn-primary">Send OTP to Email</button>
                </div>
            </div>
            
            <div id="reg-step-2" class="hidden mt-3">
                <div class="alert alert-info">OTP sent! (Check browser alert)</div>
                <div class="mb-3"><label>Enter OTP</label><input type="text" id="regOTP" class="form-control"></div>
                <div class="d-grid">
                    <button onclick="verifyRegisterOTP()" class="btn btn-success">Verify & Register</button>
                </div>
            </div>
            <div class="mt-3 text-center">
                <a href="#" onclick="switchAuth('login')">Back to Login</a>
            </div>
        </div>
    </div>

    <div id="view-reset" class="container auth-container hidden">
        <div class="auth-card">
            <h3 class="text-center mb-4">Reset Password</h3>
            <div id="reset-step-1">
                <div class="mb-3"><label>Email</label><input type="email" id="resetEmail" class="form-control"></div>
                <div class="mb-3"><label>New Password</label><input type="password" id="resetPass" class="form-control"></div>
                <div class="d-grid">
                    <button onclick="sendResetOTP()" class="btn btn-warning">Send OTP</button>
                </div>
            </div>

            <div id="reset-step-2" class="hidden mt-3">
                <div class="alert alert-info">OTP sent! (Check browser alert)</div>
                <div class="mb-3"><label>Enter OTP</label><input type="text" id="resetOTP" class="form-control"></div>
                <div class="d-grid">
                    <button onclick="verifyResetOTP()" class="btn btn-success">Change Password</button>
                </div>
            </div>
            <div class="mt-3 text-center">
                <a href="#" onclick="switchAuth('login')">Back to Login</a>
            </div>
        </div>
    </div>

    <div id="main-app" class="hidden">
        
        <nav class="navbar navbar-dark bg-dark mb-3">
            <div class="container-fluid">
                <span class="navbar-brand mb-0 h1">Defect Registration System</span>
                <div class="d-flex align-items-center text-white">
                    <span id="user-display" class="me-3"></span>
                    <button class="btn btn-outline-light btn-sm me-2" onclick="showPage('dashboard')">Home</button>
                    <button id="admin-btn" class="btn btn-warning btn-sm me-2 hidden" onclick="showPage('admin-panel')">Approvals</button>
                    <button class="btn btn-danger btn-sm" onclick="logout()">Logout</button>
                </div>
            </div>
        </nav>

        <div id="dashboard" class="container page-section active-page">
            <h2 class="mb-4 border-bottom pb-2">Dashboard</h2>
            <div class="row mb-5 text-center">
                <div class="col-md-3"><div class="card text-white bg-primary mb-3"><div class="card-body"><h5>Current Month</h5><h2 id="metric-month">0</h2></div></div></div>
                <div class="col-md-3"><div class="card text-white bg-info mb-3"><div class="card-body"><h5>Current Fin. Year</h5><h2 id="metric-year">0</h2></div></div></div>
                <div class="col-md-3"><div class="card text-white bg-danger mb-3"><div class="card-body"><h5>Open Defects</h5><h2 id="metric-open">0</h2></div></div></div>
                <div class="col-md-3"><div class="card text-white bg-success mb-3"><div class="card-body"><h5>Closed Defects</h5><h2 id="metric-closed">0</h2></div></div></div>
            </div>
            <div class="row g-4">
                <div class="col-md-4"><div class="card text-white bg-secondary nav-btn" onclick="showPage('log-defect')">Log a new defect</div></div>
                <div class="col-md-4"><div class="card text-white bg-dark nav-btn" onclick="showPage('close-defect')">Close a defect</div></div>
                <div class="col-md-4"><div class="card text-white bg-secondary nav-btn" onclick="showPage('reports')">Reports</div></div>
            </div>
        </div>

        <div id="log-defect" class="container page-section">
            <h2 class="mb-4">Log New Defect</h2>
            <div class="card p-4 shadow-sm">
                <form onsubmit="handleDefectSubmit(event)">
                    <div class="mb-3"><label>Part of Equipment *</label><input type="text" class="form-control" id="logPart" required></div>
                    <div class="mb-3"><label>Location *</label><input type="text" class="form-control" id="logLocation" required></div>
                    <div class="mb-3"><label>Description *</label><textarea class="form-control" id="logDesc" required></textarea></div>
                    <div class="row mb-3">
                        <div class="col-6"><label>Responsibility *</label><input type="text" class="form-control" id="logResp" required></div>
                        <div class="col-6"><label>Target Date</label><input type="date" class="form-control" id="logTarget"></div>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">Submit</button>
                </form>
            </div>
        </div>

        <div id="close-defect" class="container page-section">
            <h2 class="mb-4">Close Defect</h2>
            <div class="row mb-3">
                <div class="col-md-4"><input type="text" class="form-control" id="searchLogNo" placeholder="Log No..." onkeyup="renderCloseTable()"></div>
                <div class="col-md-4"><select class="form-select" id="searchMonth" onchange="renderCloseTable()"><option value="">Month</option><option value="01">Jan</option><option value="02">Feb</option><option value="03">Mar</option><option value="04">Apr</option><option value="05">May</option><option value="06">Jun</option><option value="07">Jul</option><option value="08">Aug</option><option value="09">Sep</option><option value="10">Oct</option><option value="11">Nov</option><option value="12">Dec</option></select></div>
            </div>
            <table class="table table-hover table-bordered"><thead class="table-dark"><tr><th>Log No</th><th>Date</th><th>Part</th><th>Loc</th><th>Desc</th><th>Resp</th></tr></thead><tbody id="closeTableBody"></tbody></table>
        </div>

        <div id="reports" class="container page-section">
            <h2 class="mb-4">Reports</h2>
            <div class="row mb-3">
                <div class="col-md-3"><input type="text" class="form-control" id="repLogNo" placeholder="Log No" onkeyup="renderReportTable()"></div>
                <div class="col-md-3"><button class="btn btn-success w-100" onclick="exportToExcel()">Export Excel</button></div>
            </div>
            <table class="table table-striped table-bordered"><thead class="table-dark"><tr><th>Log No</th><th>Status</th><th>Date</th><th>Part</th><th>Desc</th><th>Comp. Date</th><th>Remarks</th></tr></thead><tbody id="reportTableBody"></tbody></table>
        </div>

        <div id="admin-panel" class="container page-section">
            <h2 class="mb-4">Administrator - User Approvals</h2>
            <div class="alert alert-warning">The following users have registered and are waiting for approval to login.</div>
            <table class="table table-bordered bg-white">
                <thead class="table-dark">
                    <tr><th>Name</th><th>Email</th><th>Action</th></tr>
                </thead>
                <tbody id="approvalTableBody"></tbody>
            </table>
        </div>

    </div>

    <div class="modal fade" id="closeModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header bg-dark text-white"><h5 class="modal-title">Close Defect</h5><button class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body"><form onsubmit="finishClose(event)"><input type="hidden" id="c_logId"><div class="mb-3"><label>Compliance Date</label><input type="date" class="form-control" id="c_compDate" required></div><div class="mb-3"><label>Remarks</label><input type="text" class="form-control" id="c_remarks"></div><button type="submit" class="btn btn-success w-100">Submit</button></form></div></div></div></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // ================== DATA STORE ==================
        // Users: { email, name, password, role ('admin'/'user'), approved (bool) }
        // Defects: Existing structure
        
        let users = JSON.parse(localStorage.getItem('sysUsers')) || [];
        let defects = JSON.parse(localStorage.getItem('defectData')) || [];
        let generatedOTP = null;
        let currentUser = null;

        // Initialize Admin if not exists
        if(users.length === 0) {
            users.push({ name: "System Admin", email: "admin@sys.com", password: "admin123", role: "admin", approved: true });
            localStorage.setItem('sysUsers', JSON.stringify(users));
        }

        // ================== AUTH LOGIC ==================

        function switchAuth(view) {
            ['view-login', 'view-register', 'view-reset'].forEach(id => document.getElementById(id).classList.add('hidden'));
            document.getElementById(`view-${view}`).classList.remove('hidden');
            // Reset forms
            document.getElementById('reg-step-1').classList.remove('hidden');
            document.getElementById('reg-step-2').classList.add('hidden');
            document.getElementById('reset-step-1').classList.remove('hidden');
            document.getElementById('reset-step-2').classList.add('hidden');
        }

        function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const pass = document.getElementById('loginPass').value;
            
            const user = users.find(u => u.email === email && u.password === pass);

            if (!user) {
                alert("Invalid Email or Password");
                return;
            }
            if (!user.approved) {
                alert("Account registered but not approved by Admin yet.");
                return;
            }

            // Login Success
            currentUser = user;
            document.getElementById('view-login').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            document.getElementById('user-display').innerText = `Hello, ${user.name}`;
            
            if(user.role === 'admin') {
                document.getElementById('admin-btn').classList.remove('hidden');
            } else {
                document.getElementById('admin-btn').classList.add('hidden');
            }

            updateDashboard();
        }

        function logout() {
            currentUser = null;
            document.getElementById('main-app').classList.add('hidden');
            switchAuth('login');
            document.getElementById('loginEmail').value = '';
            document.getElementById('loginPass').value = '';
        }

        // --- OTP SIMULATION ---
        function generateAndAlertOTP(email) {
            generatedOTP = Math.floor(1000 + Math.random() * 9000).toString();
            // SIMULATION: In real life this goes to email server. Here we alert.
            setTimeout(() => {
                alert(`[EMAIL SERVER SIMULATION]\n\n To: ${email}\n Subject: Your Verification Code\n\n Your OTP is: ${generatedOTP}`);
            }, 500);
        }

        // --- REGISTRATION ---
        function sendRegisterOTP() {
            const email = document.getElementById('regEmail').value;
            if(!email) return alert("Enter email first");
            if(users.find(u => u.email === email)) return alert("Email already exists");

            generateAndAlertOTP(email);
            document.getElementById('reg-step-1').classList.add('hidden');
            document.getElementById('reg-step-2').classList.remove('hidden');
        }

        function verifyRegisterOTP() {
            const input = document.getElementById('regOTP').value;
            if(input !== generatedOTP) return alert("Wrong OTP");

            const newUser = {
                name: document.getElementById('regName').value,
                email: document.getElementById('regEmail').value,
                password: document.getElementById('regPass').value,
                role: 'user',
                approved: false // REQUIRES ADMIN APPROVAL
            };
            
            users.push(newUser);
            localStorage.setItem('sysUsers', JSON.stringify(users));
            
            alert("Registration Successful! Please wait for Administrator approval before logging in.");
            switchAuth('login');
        }

        // --- RESET PASSWORD ---
        function sendResetOTP() {
            const email = document.getElementById('resetEmail').value;
            if(!users.find(u => u.email === email)) return alert("Email not found in system");
            
            generateAndAlertOTP(email);
            document.getElementById('reset-step-1').classList.add('hidden');
            document.getElementById('reset-step-2').classList.remove('hidden');
        }

        function verifyResetOTP() {
            const input = document.getElementById('resetOTP').value;
            if(input !== generatedOTP) return alert("Wrong OTP");

            const email = document.getElementById('resetEmail').value;
            const newPass = document.getElementById('resetPass').value;
            
            const idx = users.findIndex(u => u.email === email);
            users[idx].password = newPass;
            localStorage.setItem('sysUsers', JSON.stringify(users));

            alert("Password Reset Successfully.");
            switchAuth('login');
        }

        // ================== APP LOGIC (DEFECT SYSTEM) ==================
        
        function showPage(pageId) {
            document.querySelectorAll('.page-section').forEach(el => el.classList.remove('active-page'));
            document.getElementById(pageId).classList.add('active-page');
            
            if(pageId === 'dashboard') updateDashboard();
            if(pageId === 'close-defect') renderCloseTable();
            if(pageId === 'reports') renderReportTable();
            if(pageId === 'admin-panel') renderApprovalTable();
        }

        // 1. DASHBOARD LOGIC
        function getFY(dStr) {
            const d = new Date(dStr);
            const y = d.getFullYear();
            return (d.getMonth() + 1 >= 4) ? `${y}-${y+1}` : `${y-1}-${y}`;
        }

        function updateDashboard() {
            const now = new Date();
            const curM = now.getMonth(), curY = now.getFullYear();
            const curFY = getFY(now.toISOString());
            
            let m=0, y=0, op=0, cl=0;
            defects.forEach(d => {
                const dd = new Date(d.entryDate);
                if(dd.getMonth()===curM && dd.getFullYear()===curY) m++;
                if(d.fy === curFY) y++;
                d.status === 'Open' ? op++ : cl++;
            });
            
            document.getElementById('metric-month').innerText = m;
            document.getElementById('metric-year').innerText = y;
            document.getElementById('metric-open').innerText = op;
            document.getElementById('metric-closed').innerText = cl;
        }

        // 2. LOG DEFECT
        function handleDefectSubmit(e) {
            e.preventDefault();
            const now = new Date();
            const prefix = `${now.getFullYear().toString().slice(-2)}/${(now.getMonth()+1).toString().padStart(2,'0')}-`;
            const count = defects.filter(d => d.logNo.startsWith(prefix)).length + 1;
            
            const obj = {
                logNo: prefix + count,
                entryDate: now.toISOString().split('T')[0],
                fy: getFY(now.toISOString()),
                part: document.getElementById('logPart').value,
                location: document.getElementById('logLocation').value,
                desc: document.getElementById('logDesc').value,
                resp: document.getElementById('logResp').value,
                target: document.getElementById('logTarget').value,
                status: 'Open',
                compDate: '', remarks: ''
            };
            
            defects.push(obj);
            localStorage.setItem('defectData', JSON.stringify(defects));
            alert("Logged: " + obj.logNo);
            e.target.reset();
            showPage('dashboard');
        }
        
                // 3. CLOSE DEFECT
        function renderCloseTable() {
            const txt = document.getElementById('searchLogNo').value.toLowerCase();
            const month = document.getElementById('searchMonth').value;
            const tbody = document.getElementById('closeTableBody');
            tbody.innerHTML = '';

            let list = defects.filter(d => d.status === 'Open');
            if(txt) list = list.filter(d => d.logNo.toLowerCase().includes(txt));
            if(month) list = list.filter(d => d.entryDate.split('-')[1] === month);
            list.sort((a,b) => new Date(b.entryDate) - new Date(a.entryDate));

            list.forEach(d => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td><a href="#" onclick="openModal('${d.logNo}')">${d.logNo}</a></td><td>${d.entryDate}</td><td>${d.part}</td><td>${d.location}</td><td>${d.desc}</td><td>${d.resp}</td>`;
                tbody.appendChild(tr);
            });
        }

        function openModal(id) {
            document.getElementById('c_logId').value = id;
            new bootstrap.Modal(document.getElementById('closeModal')).show();
        }

        function finishClose(e) {
            e.preventDefault();
            const id = document.getElementById('c_logId').value;
            const idx = defects.findIndex(d => d.logNo === id);
            if(idx > -1) {
                defects[idx].status = 'Closed';
                defects[idx].compDate = document.getElementById('c_compDate').value;
                defects[idx].remarks = document.getElementById('c_remarks').value;
                localStorage.setItem('defectData', JSON.stringify(defects));
                bootstrap.Modal.getInstance(document.getElementById('closeModal')).hide();
                renderCloseTable();
            }
        }

        // 4. REPORTS
        function renderReportTable() {
            const txt = document.getElementById('repLogNo').value.toLowerCase();
            const tbody = document.getElementById('reportTableBody');
            tbody.innerHTML = '';
            
            let list = [...defects];
            if(txt) list = list.filter(d => d.logNo.toLowerCase().includes(txt));
            list.sort((a,b) => new Date(b.entryDate) - new Date(a.entryDate));

            list.forEach(d => {
                tbody.innerHTML += `<tr><td>${d.logNo}</td><td>${d.status}</td><td>${d.entryDate}</td><td>${d.part}</td><td>${d.desc}</td><td>${d.compDate}</td><td>${d.remarks}</td></tr>`;
            });
        }

        function exportToExcel() {
            const ws = XLSX.utils.json_to_sheet(defects);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Data");
            XLSX.writeFile(wb, "DefectData.xlsx");
        }

        // ================== ADMIN APPROVAL LOGIC ==================
        function renderApprovalTable() {
            const tbody = document.getElementById('approvalTableBody');
            tbody.innerHTML = '';
            
            const pendingUsers = users.filter(u => !u.approved);
            
            if(pendingUsers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" class="text-center">No pending approvals</td></tr>';
                return;
            }

            pendingUsers.forEach(u => {
                tbody.innerHTML += `
                    <tr>
                        <td>${u.name}</td>
                        <td>${u.email}</td>
                        <td><button class="btn btn-success btn-sm" onclick="approveUser('${u.email}')">Approve</button></td>
                    </tr>
                `;
            });
        }

        function approveUser(email) {
            const idx = users.findIndex(u => u.email === email);
            if(idx > -1) {
                users[idx].approved = true;
                localStorage.setItem('sysUsers', JSON.stringify(users));
                renderApprovalTable();
                alert(`User ${email} approved!`);
            }
        }

        // Initial Load
        switchAuth('login');
    </script>
</body>
</html>