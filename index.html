<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Defect System - Image Support</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        body { background-color: #f4f6f9; font-family: 'Segoe UI', system-ui, sans-serif; }
        .login-wrapper { height: 100vh; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #212529 0%, #343a40 100%); }
        .login-card { width: 100%; max-width: 420px; padding: 40px; border-radius: 15px; background: white; box-shadow: 0 15px 35px rgba(0,0,0,0.3); }
        .hidden { display: none !important; }
        .page-section { display: none; animation: fadeIn 0.4s; padding-bottom: 50px; }
        .active-page { display: block; }
        .stat-card { border: none; border-radius: 12px; color: white; transition: transform 0.2s; }
        .stat-card:hover { transform: translateY(-5px); }
        .nav-btn { height: 120px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; font-weight: 600; cursor: pointer; border-radius: 12px; transition: 0.2s; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .nav-btn:hover { transform: scale(1.03); }
        .filter-bar { background: #e9ecef; border-radius: 8px; padding: 20px; margin-bottom: 20px; border: 1px solid #dee2e6; }
        .img-preview { max-width: 100%; height: auto; border-radius: 8px; border: 1px solid #ddd; padding: 4px; margin-top: 10px; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div id="view-login" class="login-wrapper">
        <div class="login-card">
            <h3 class="text-center fw-bold mb-4 text-dark">System Access</h3>
            <form onsubmit="handleLogin(event)">
                <div class="mb-3">
                    <label class="form-label text-muted">Select Role</label>
                    <select id="loginRole" class="form-select form-select-lg mb-3">
                        <option value="user">Regular User</option>
                        <option value="admin">Administrator</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label class="form-label">Password</label>
                    <input type="password" id="loginPass" class="form-control form-control-lg" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                </div>
                <button type="submit" class="btn btn-dark w-100 btn-lg fw-bold">Login</button>
            </form>
        </div>
    </div>

    <div id="main-app" class="hidden">
        <nav class="navbar navbar-dark bg-dark sticky-top shadow-sm mb-4">
            <div class="container">
                <a class="navbar-brand fw-bold" href="#">Defect Manager Pro</a>
                <div class="d-flex align-items-center gap-3">
                    <span class="badge bg-light text-dark px-3 py-2" id="user-badge"></span>
                    <button class="btn btn-outline-danger btn-sm" onclick="logout()">Logout</button>
                </div>
            </div>
        </nav>

        <div class="container">
            <div id="dashboard" class="page-section active-page">
                <div class="d-flex justify-content-between align-items-end mb-4 border-bottom pb-2">
                    <h2>Dashboard</h2>
                    <span class="text-muted small" id="date-display"></span>
                </div>
                <div class="row g-4 mb-5">
                    <div class="col-lg-8">
                        <div class="row g-3">
                            <div class="col-md-6"><div class="card stat-card bg-primary p-3"><div class="card-body"><h5>Total Logged</h5><h2 id="m-total">0</h2></div></div></div>
                            <div class="col-md-6"><div class="card stat-card bg-success p-3"><div class="card-body"><h5>Closed</h5><h2 id="m-closed">0</h2></div></div></div>
                            <div class="col-md-6"><div class="card stat-card bg-danger p-3"><div class="card-body"><h5>Open / Pending</h5><h2 id="m-open">0</h2></div></div></div>
                            <div class="col-md-6"><div class="card stat-card bg-info p-3"><div class="card-body"><h5>Current FY</h5><h2 id="m-fy">0</h2></div></div></div>
                        </div>
                    </div>
                    <div class="col-lg-4">
                        <div class="card p-3 shadow-sm h-100 justify-content-center">
                            <canvas id="statusChart" style="max-height: 200px;"></canvas>
                        </div>
                    </div>
                </div>
                <div class="row g-4">
                    <div class="col-md-4"><div class="card text-white bg-dark nav-btn" onclick="showPage('log-defect')">üìù Log New Defect</div></div>
                    <div class="col-md-4"><div class="card text-white bg-secondary nav-btn" onclick="showPage('close-defect')">üõ† Close Defect</div></div>
                    <div class="col-md-4"><div class="card text-white bg-dark nav-btn" onclick="showPage('reports')">üìä Master Report</div></div>
                </div>
            </div>

            <div id="log-defect" class="page-section">
                <button class="btn btn-link text-decoration-none mb-3 ps-0" onclick="showPage('dashboard')">‚Üê Back to Dashboard</button>
                <h3 class="mb-4">Log New Defect</h3>
                <div class="card p-4 shadow-sm border-0">
                    <form onsubmit="handleSubmit(event)">
                        <div class="row mb-3">
                            <div class="col-md-6"><label class="form-label">Part / Equipment</label><input type="text" id="inPart" class="form-control" required></div>
                            <div class="col-md-6"><label class="form-label">Location</label><input type="text" id="inLoc" class="form-control" required></div>
                        </div>
                        <div class="mb-3"><label class="form-label">Description</label><textarea id="inDesc" class="form-control" rows="3" required></textarea></div>
                        <div class="row mb-3">
                            <div class="col-md-6"><label class="form-label">Responsibility</label><input type="text" id="inResp" class="form-control" required></div>
                            <div class="col-md-6"><label class="form-label">Target Date</label><input type="date" id="inTarget" class="form-control"></div>
                        </div>
                        
                        <div class="mb-3 p-3 bg-light rounded border">
                            <label class="form-label fw-bold">Defect Image</label>
                            <input type="file" id="inImage" accept="image/*" capture="environment" class="form-control">
                            <div class="form-text">Upload or Capture photo.</div>
                        </div>

                        <button type="submit" id="btnSubmitLog" class="btn btn-primary w-100 btn-lg">Submit Entry</button>
                    </form>
                </div>
            </div>

            <div id="close-defect" class="page-section">
                <button class="btn btn-link text-decoration-none mb-3 ps-0" onclick="showPage('dashboard')">‚Üê Back to Dashboard</button>
                <h3>Pending Actions</h3>
                <input type="text" class="form-control mb-3" placeholder="Search open defects..." onkeyup="renderCloseTable(this.value)">
                <div class="table-responsive bg-white shadow-sm rounded">
                    <table class="table table-hover mb-0">
                        <thead class="table-light"><tr><th>Action</th><th>Log No</th><th>Date</th><th>Desc</th><th>Image</th></tr></thead>
                        <tbody id="closeTableBody"></tbody>
                    </table>
                </div>
            </div>

            <div id="reports" class="page-section">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <button class="btn btn-link text-decoration-none ps-0" onclick="showPage('dashboard')">‚Üê Back</button>
                    <div class="d-flex gap-2">
                        <input type="file" id="fileImport" accept=".xlsx, .xls" class="hidden" onchange="handleImport(this)">
                        <button class="btn btn-primary btn-sm admin-only hidden" onclick="triggerImport()">üìÇ Import</button>
                        <button class="btn btn-success btn-sm" onclick="exportExcel()">Download Filtered Excel</button>
                    </div>
                </div>
                <h3>Master Report</h3>
                <div id="admin-notice" class="alert alert-warning py-2 small hidden"><strong>Admin Mode:</strong> You can Delete and Import records.</div>
                
                <div class="filter-bar">
                    <div class="row g-3">
                        <div class="col-md-3"><span class="filter-label">From Date</span><input type="date" id="f_start" class="form-control form-control-sm" onchange="renderReportTable()"></div>
                        <div class="col-md-3"><span class="filter-label">To Date</span><input type="date" id="f_end" class="form-control form-control-sm" onchange="renderReportTable()"></div>
                        <div class="col-md-2"><span class="filter-label">Status</span><select id="f_status" class="form-select form-select-sm" onchange="renderReportTable()"><option value="">All Status</option><option value="Open">Open</option><option value="Closed">Closed</option></select></div>
                        <div class="col-md-3"><span class="filter-label">Search</span><input type="text" id="f_text" class="form-control form-control-sm" placeholder="Search..." onkeyup="renderReportTable()"></div>
                        <div class="col-md-1 d-flex align-items-end"><button class="btn btn-secondary btn-sm w-100" onclick="clearFilters()">Reset</button></div>
                    </div>
                </div>

                <div class="table-responsive bg-white shadow-sm rounded">
                    <table class="table table-bordered mb-0">
                        <thead class="table-dark">
                            <tr>
                                <th>Log No</th>
                                <th>Status</th>
                                <th>Date</th>
                                <th>Equipment</th>
                                <th>Description</th>
                                <th>Remarks</th>
                                <th>Img</th>
                                <th class="admin-only hidden text-center">Delete</th>
                            </tr>
                        </thead>
                        <tbody id="reportTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="closeModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-success text-white"><h5 class="modal-title">Close Job</h5><button class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <form onsubmit="confirmClose(event)">
                        <input type="hidden" id="modalLogId">
                        <div class="mb-3"><label>Completion Date</label><input type="date" id="modalDate" class="form-control" required></div>
                        <div class="mb-3"><label>Remarks</label><textarea id="modalRem" class="form-control" required></textarea></div>
                        
                        <div class="mb-3 p-3 bg-light rounded border">
                            <label class="form-label fw-bold">Image </label>
                            <input type="file" id="closeImage" accept="image/*" capture="environment" class="form-control">
                        </div>

                        <button type="submit" id="btnCloseSubmit" class="btn btn-success w-100">Save & Close</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="imageModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">Evidence Photos</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body text-center">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Before (Defect)</h6>
                            <img id="viewImgBefore" src="" class="img-fluid border rounded" alt="No Image">
                            <p id="noImgBefore" class="text-muted mt-2 hidden">No image provided</p>
                        </div>
                        <div class="col-md-6">
                            <h6>After (Fixed)</h6>
                            <img id="viewImgAfter" src="" class="img-fluid border rounded" alt="No Image">
                            <p id="noImgAfter" class="text-muted mt-2 hidden">No image provided</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        
        // ================= CONFIG =================
        const SYSTEM_CONFIG = { 'admin': 'Pass@32Lwq', 'user':  'ASDS@#41' };
        const DB_KEY = 'defect_db_v5_img';
        
        // ================= STATE =================
        let defects = JSON.parse(localStorage.getItem(DB_KEY)) || [];
        let currentUser = null; 
        let chartInstance = null;

        // ================= AUTH =================
        function handleLogin(e) {
            e.preventDefault();
            const role = document.getElementById('loginRole').value;
            const pass = document.getElementById('loginPass').value;
            if (SYSTEM_CONFIG[role] && pass === SYSTEM_CONFIG[role]) {
                loginSuccess(role === 'admin' ? 'Administrator' : 'Regular User', role);
            } else { alert("Invalid Password."); }
        }

        function loginSuccess(name, role) {
            currentUser = { name, role };
            document.getElementById('view-login').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            document.getElementById('user-badge').innerText = name;
            document.getElementById('date-display').innerText = new Date().toDateString();
            
            // Admin Toggle
            const isAdmin = role === 'admin';
            document.getElementById('admin-notice').classList.toggle('hidden', !isAdmin);
            document.querySelectorAll('.admin-only').forEach(el => el.classList.toggle('hidden', !isAdmin));
            
            showPage('dashboard');
        }

        function logout() {
            currentUser = null;
            document.getElementById('main-app').classList.add('hidden');
            document.getElementById('view-login').classList.remove('hidden');
            document.getElementById('loginPass').value = '';
        }

        // ================= UTILS: IMAGE COMPRESSION =================
        // Compresses image to max 800px width to save LocalStorage space
        function compressImage(file) {
            return new Promise((resolve) => {
                if (!file) return resolve(null);
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const MAX_WIDTH = 800;
                        const scaleSize = MAX_WIDTH / img.width;
                        canvas.width = (scaleSize < 1) ? MAX_WIDTH : img.width;
                        canvas.height = (scaleSize < 1) ? img.height * scaleSize : img.height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        resolve(canvas.toDataURL('image/jpeg', 0.5)); // Compress to 50% Quality
                    };
                };
            });
        }

        // ================= NAVIGATION =================
        function showPage(pageId) {
            document.querySelectorAll('.page-section').forEach(el => el.classList.remove('active-page'));
            document.getElementById(pageId).classList.add('active-page');
            if(pageId === 'dashboard') updateDashboard();
            if(pageId === 'close-defect') renderCloseTable();
            if(pageId === 'reports') renderReportTable();
        }

        // ================= DASHBOARD =================
        function updateDashboard() {
            const now = new Date();
            const fyStart = now.getMonth() >= 3 ? now.getFullYear() : now.getFullYear() - 1;
            const fyStr = `${fyStart}-${fyStart+1}`;
            let open = 0, closed = 0, fyCount = 0;
            defects.forEach(d => {
                if(d.status === 'Open') open++; else closed++;
                if(d.fy === fyStr) fyCount++;
            });
            document.getElementById('m-total').innerText = defects.length;
            document.getElementById('m-open').innerText = open;
            document.getElementById('m-closed').innerText = closed;
            document.getElementById('m-fy').innerText = fyCount;
            
            const ctx = document.getElementById('statusChart').getContext('2d');
            if(chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: { labels: ['Open', 'Closed'], datasets: [{ data: [open, closed], backgroundColor: ['#dc3545', '#198754'] }] },
                options: { plugins: { legend: { position: 'bottom' } }, maintainAspectRatio: false }
            });
        }

        // ================= LOG DEFECT =================
        async function handleSubmit(e) {
            e.preventDefault();
            const btn = document.getElementById('btnSubmitLog');
            btn.disabled = true; btn.innerText = "Processing...";

            const now = new Date();
            const year = now.getFullYear();
            const month = (now.getMonth() + 1).toString().padStart(2, '0');
            const prefix = `${year}/${month}/`;
            const existingForMonth = defects.filter(d => d.logNo.startsWith(prefix));
            
            let nextSerial = 1;
            if (existingForMonth.length > 0) {
                const serials = existingForMonth.map(d => parseInt(d.logNo.split('/')[2]));
                nextSerial = Math.max(...serials) + 1;
            }
            const id = `${prefix}${nextSerial.toString().padStart(2, '0')}`;
            const fyStart = now.getMonth() >= 3 ? now.getFullYear() : now.getFullYear() - 1;

            // Handle Image
            const imgFile = document.getElementById('inImage').files[0];
            const imgData = await compressImage(imgFile);

            const newLog = {
                logNo: id, status: 'Open', entryDate: now.toISOString().split('T')[0],
                fy: `${fyStart}-${fyStart+1}`,
                part: document.getElementById('inPart').value,
                loc: document.getElementById('inLoc').value,
                desc: document.getElementById('inDesc').value,
                resp: document.getElementById('inResp').value,
                target: document.getElementById('inTarget').value,
                compDate: '', remarks: '',
                imgBefore: imgData, 
                imgAfter: null
            };

            defects.push(newLog);
            saveData();
            e.target.reset();
            alert(`Defect Logged: ${id}`);
            btn.disabled = false; btn.innerText = "Submit Entry";
            showPage('dashboard');
        }

        // ================= CLOSE DEFECT =================
        function renderCloseTable(filter = '') {
            const tbody = document.getElementById('closeTableBody');
            tbody.innerHTML = '';
            const list = defects.filter(d => d.status === 'Open' && (d.desc.toLowerCase().includes(filter.toLowerCase()) || d.part.toLowerCase().includes(filter.toLowerCase())));
            
            if(list.length === 0) tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted p-4">No open defects found</td></tr>';
            
            list.forEach(d => {
                const imgIcon = d.imgBefore ? `<button class="btn btn-sm btn-outline-primary" onclick="viewImages('${d.logNo}')">üì∑ View</button>` : '-';
                tbody.innerHTML += `<tr><td><button class="btn btn-sm btn-success" onclick="openCloseModal('${d.logNo}')">Close</button></td><td>${d.logNo}</td><td>${d.entryDate}</td><td>${d.desc}</td><td>${imgIcon}</td></tr>`;
            });
        }

        function openCloseModal(id) { document.getElementById('modalLogId').value = id; new bootstrap.Modal(document.getElementById('closeModal')).show(); }

        async function confirmClose(e) {
            e.preventDefault();
            const btn = document.getElementById('btnCloseSubmit');
            btn.disabled = true; btn.innerText = "Processing...";

            const id = document.getElementById('modalLogId').value;
            const idx = defects.findIndex(d => d.logNo === id);
            
            if(idx > -1) {
                // Handle Image
                const imgFile = document.getElementById('closeImage').files[0];
                const imgData = await compressImage(imgFile);

                defects[idx].status = 'Closed';
                defects[idx].compDate = document.getElementById('modalDate').value;
                defects[idx].remarks = document.getElementById('modalRem').value;
                defects[idx].imgAfter = imgData;

                saveData();
                bootstrap.Modal.getInstance(document.getElementById('closeModal')).hide();
                renderCloseTable();
            }
            btn.disabled = false; btn.innerText = "Save & Close";
        }

        // ================= REPORTING =================
        function getFilteredDefects() {
            const start = document.getElementById('f_start').value;
            const end = document.getElementById('f_end').value;
            const status = document.getElementById('f_status').value;
            const text = document.getElementById('f_text').value.toLowerCase();
            return defects.filter(d => {
                let dateOk = (!start || d.entryDate >= start) && (!end || d.entryDate <= end);
                let statusOk = (status === "") || (d.status === status);
                let textOk = !text || (d.logNo+d.part+d.resp+d.desc).toLowerCase().includes(text);
                return dateOk && statusOk && textOk;
            }).sort((a,b) => new Date(b.entryDate) - new Date(a.entryDate));
        }

        function renderReportTable() {
            const tbody = document.getElementById('reportTableBody');
            const list = getFilteredDefects();
            const isAdmin = currentUser && currentUser.role === 'admin';
            
            tbody.innerHTML = '';
            if(list.length === 0) { tbody.innerHTML = '<tr><td colspan="8" class="text-center p-4 text-muted">No records match filters</td></tr>'; return; }
            
            list.forEach(d => {
                const badge = d.status === 'Open' ? 'bg-danger' : 'bg-success';
                let deleteBtn = isAdmin ? `<td class="text-center"><button class="btn btn-sm btn-outline-danger" onclick="deleteLog('${d.logNo}')">üóë</button></td>` : '';
                
                // Image Button
                let imgBtn = '-';
                if(d.imgBefore || d.imgAfter) {
                    imgBtn = `<button class="btn btn-sm btn-outline-info" onclick="viewImages('${d.logNo}')">üì∑</button>`;
                }

                tbody.innerHTML += `<tr><td class="fw-bold">${d.logNo}</td><td><span class="badge ${badge}">${d.status}</span></td><td>${d.entryDate}</td><td>${d.part}</td><td>${d.desc}</td><td>${d.remarks || '-'}</td><td class="text-center">${imgBtn}</td>${deleteBtn}</tr>`;
            });
        }

        function viewImages(id) {
            const d = defects.find(x => x.logNo === id);
            
            const setImg = (elId, msgId, src) => {
                const img = document.getElementById(elId);
                const msg = document.getElementById(msgId);
                if(src) { img.src = src; img.classList.remove('hidden'); msg.classList.add('hidden'); }
                else { img.classList.add('hidden'); msg.classList.remove('hidden'); }
            };

            setImg('viewImgBefore', 'noImgBefore', d.imgBefore);
            setImg('viewImgAfter', 'noImgAfter', d.imgAfter);

            new bootstrap.Modal(document.getElementById('imageModal')).show();
        }

        function clearFilters() { ['f_start', 'f_end', 'f_status', 'f_text'].forEach(id => document.getElementById(id).value = ''); renderReportTable(); }
        function deleteLog(id) { if(confirm(`Delete Log #${id}?`)) { defects = defects.filter(d => d.logNo !== id); saveData(); renderReportTable(); } }
        function saveData() { localStorage.setItem(DB_KEY, JSON.stringify(defects)); }

        // ================= IMPORT / EXPORT =================
        function exportExcel() {
            if(typeof XLSX === 'undefined') return alert("Error: Excel library not loaded.");
            const list = getFilteredDefects();
            if(list.length === 0) return alert("No data matches filters.");
            
            // Exclude large image strings from excel
            const data = list.map(d => ({ "Log No": d.logNo, "Status": d.status, "Date": d.entryDate, "FY": d.fy, "Part": d.part, "Location": d.loc, "Description": d.desc, "Responsibility": d.resp, "Target Date": d.target, "Completed On": d.compDate, "Remarks": d.remarks, "HasImage": (d.imgBefore ? "Yes" : "No") }));
            
            const ws = XLSX.utils.json_to_sheet(data);
            ws['!cols'] = Object.keys(data[0]).map(k => ({ wch: 15 }));
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Defects");
            XLSX.writeFile(wb, `Defect_Report_${new Date().toISOString().slice(0,10)}.xlsx`);
        }

        function triggerImport() { document.getElementById('fileImport').click(); }
        function handleImport(input) {
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const json = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                if(json.length === 0) return alert("File empty!");
                let count = 0;
                json.forEach(row => {
                    if(!defects.find(d => d.logNo === row["Log No"])) {
                        defects.push({
                            logNo: row["Log No"] || `IMP-${Math.random().toString().substr(2,6)}`,
                            status: row["Status"] || "Open",
                            entryDate: row["Date"] || new Date().toISOString().split('T')[0],
                            fy: row["FY"] || "",
                            part: row["Part"] || "",
                            loc: row["Location"] || "",
                            desc: row["Description"] || "",
                            resp: row["Responsibility"] || "",
                            target: row["Target Date"] || "",
                            compDate: row["Completed On"] || "",
                            remarks: row["Remarks"] || "",
                            imgBefore: null, imgAfter: null // Cannot import images from Excel easily
                        });
                        count++;
                    }
                });
                saveData(); renderReportTable(); alert(`Imported ${count} records!`); input.value = '';
            };
            reader.readAsArrayBuffer(file);
        }
    </script>
</body>
</html>
